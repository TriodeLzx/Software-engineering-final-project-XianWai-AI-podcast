## 1 引言

弦外（Xian Wai）是一个融合现代人工智能技术的智能播客创作工具，致力于帮助创作者便捷地将文本内容转化为高质量音频，并对生成的音频进行管理和再利用。系统基于 Web 架构实现，后端采用 Flask + SQLite，结合百度语音合成（Baidu TTS）服务，实现“文本转语音 + 用户管理 + 历史记录管理”的一体化解决方案。

本报告围绕弦外系统，从系统设计、系统实现和系统测试三个方面进行说明，重点展开“3 系统设计实现—系统实现”部分的具体实现过程和关键技术细节。

---

## 2 系统设计

### 2.1 总体架构设计

弦外系统采用典型的 B/S（Browser/Server）三层架构：

- **表现层（前端）**：基于 HTML5 + CSS3 + JavaScript 实现，主要包括登录页面、注册页面和创作主页。通过 Ajax（`fetch`）与后端 REST 风格接口进行交互，实现无刷新体验。
- **业务逻辑层（后端）**：使用 Flask 框架构建 Web 应用，负责用户认证、会话管理、文本转语音调用、历史记录管理等核心业务逻辑。
- **数据持久层（数据库）**：选用 SQLite 作为轻量级关系型数据库，通过 SQLAlchemy ORM 进行数据访问和操作。
- **外部服务层**：接入百度云语音合成（Baidu TTS）服务，通过封装类 `BaiduTTS` 将文本转换为 MP3 音频文件。

整体结构示意为：

- 浏览器（前端页面）  
  ⬇⬆ HTTP / JSON  
- Flask 应用（路由 + 业务逻辑 + SQLAlchemy 模型）  
  ⬇⬆ SQL  
- SQLite 数据库（用户、音频历史记录）  
  ⬇  
- 百度 TTS 云服务（文本合成语音）

#### 2.1.1 系统总体流程图

为了更直观地展示用户从进入系统到完成文本转语音创作的端到端过程，系统主流程可表示为下图：

```mermaid
flowchart TD
    A[进入系统] --> B{已登录?}
    B -- 否 --> C[登录/注册]
    C --> D[进入创作页]
    B -- 是 --> D
    D --> E[输入文本&参数]
    E --> F[提交生成请求 /api/generate-audio]
    F -->|成功| G[生成MP3并写入历史]
    F -->|失败| H[提示错误]
    G --> I[前端展示播放器]
    I --> J[播放/下载音频]
    G --> K[历史记录页加载 /api/history]
    K --> L[删除/清空历史]
    L --> K
    J --> M[退出登录]
    M --> A
```

#### 2.1.2 系统 0 层数据流图（DFD）

从数据流角度看，弦外系统整体可抽象为若干处理过程和数据存储，0 层数据流图如下：

```mermaid
flowchart LR
    User[用户]
    subgraph XW[弦外系统]
        P1[用户管理]
        P2[文本转语音]
        P3[历史记录管理]
        P4[音频下载]
        D1[(用户数据)]
        D2[(音频历史)]
        D3[(音频文件)]
    end

    User <--> P1
    P1 <--> D1

    User <--> P2
    P2 <--> D2
    P2 <--> D3

    User <--> P3
    P3 <--> D2

    User <--> P4
    P4 <--> D3
```

### 2.2 功能模块设计

系统主要功能模块包括：

- **用户管理模块**  
  - 用户注册：支持用户名 + 邮箱注册，密码加密存储。  
  - 用户登录：支持使用“用户名或邮箱 + 密码”登录。  
  - 会话管理：基于 Flask Session 记录当前登录状态，实现登录保护和退出登录。

- **文本转语音模块**  
  - 文本输入与校验：支持输入中文文本，并对长度（1024 字节）进行限制。  
  - 参数配置：支持选择发音人、语速、音调、音量等 TTS 参数。  
  - 调用百度 TTS：将文本和参数传入 `BaiduTTS` 封装类生成 MP3 文件。  
  - 文件管理：生成音频统一保存到 `uploads` 目录。

- **音频历史记录模块**  
  - 历史记录查询：按照时间倒序展示当前登录用户最近生成的音频记录。  
  - 历史记录删除：支持删除单条记录，并同步删除对应音频文件。  
  - 批量清空历史：支持一键清理当前用户所有历史记录。

- **前端交互与播放模块**  
  - 创作页文本编辑、参数滑块调节。  
  - 生成语音按钮触发后端接口。  
  - 播放器组件支持在线播放与下载音频。  
  - 历史记录列表支持点击播放、下载及删除。

#### 2.2.1 系统功能结构图

从功能分解角度，系统可划分为若干一级与二级功能模块，结构关系如下：

```mermaid
mindmap
  root((弦外系统))
    用户管理
      注册
      登录/退出
      会话校验
    文本转语音
      文本输入校验
      参数选择(发音人/语速/音调/音量)
      调用百度TTS
      生成MP3
    历史记录
      列表查询
      删除单条
      清空全部
    音频下载/播放
      在线播放
      下载MP3
      权限校验
    设置
      账户信息
      默认参数偏好
```

#### 2.2.2 音频生成状态图

以“文本转语音生成请求”为例，其生命周期状态变化如图所示：

```mermaid
stateDiagram-v2
    [*] --> 准备中
    准备中 --> 校验失败 : 文本/参数不合法
    准备中 --> 调用TTS : 校验通过
    调用TTS --> 生成失败 : TTS错误/超时
    调用TTS --> 保存文件 : 返回音频数据
    保存文件 --> 写入历史
    写入历史 --> 可播放/可下载
    生成失败 --> [*]
    可播放/可下载 --> [*]
```

### 2.3 数据库设计

系统使用 SQLite 数据库，主要包含两张表：`User` 表和 `AudioHistory` 表。

- **User 表**（用户表）  
  - `id`：主键，自增整数。  
  - `username`：用户名，唯一且非空。  
  - `email`：邮箱地址，唯一且非空。  
  - `password_hash`：密码哈希值，使用 `werkzeug.security` 的 `generate_password_hash` 存储。  
  - `created_at`：账号创建时间。

- **AudioHistory 表**（音频历史记录表）  
  - `id`：主键，自增整数。  
  - `user_id`：外键，关联到 `User.id`。  
  - `text`：用于生成语音的原始文本。  
  - `filename`：生成的 MP3 文件名。  
  - `voice_id` / `voice_name`：发音人编号和名称。  
  - `speed` / `pitch` / `volume`：语速、音调、音量参数。  
  - `created_at`：生成时间。

`User` 与 `AudioHistory` 为一对多关系，通过 SQLAlchemy 的 `relationship` 建立逻辑关联，并开启 `cascade='all, delete-orphan'` 支持级联删除。

#### 2.3.1 数据存储与外部服务图

```mermaid
flowchart LR
    U[(User表: 用户数据)]
    H[(AudioHistory表: 音频历史)]
    F[(Uploads目录: MP3文件)]
    B[(Baidu TTS 云服务)]

    subgraph Flask后端
      DB[(SQLite)]
    end

    DB --- U
    DB --- H
    Flask后端 --> B
    Flask后端 --> F
```

#### 2.3.2 文本转语音 1 层数据流图

```mermaid
flowchart LR
    U[用户] --> P21[文本与参数校验]
    P21 -->|通过| P22[调用百度TTS]
    P21 -->|错误| U

    P22 -->|音频数据| P23[保存MP3]
    P23 --> D3[(音频文件 Uploads)]

    P23 --> P24[写入历史记录]
    P24 --> D2[(音频历史)]

    P24 -->|下载/播放链接| U
```

#### 2.3.3 类图（后端主要类/模型）

```mermaid
classDiagram
    class BaiduTTS {
        -app_id: str
        -api_key: str
        -secret_key: str
        -client: AipSpeech
        -default_options: dict
        +text_to_speech(text, output_file, lang, options, cuid) bool,str
        +get_supported_voices() dict
        +text_to_speech_with_retry(...)
    }

    class User {
        +id: Integer
        +username: String
        +email: String
        +password_hash: String
        +created_at: DateTime
        +audio_history: relationship
    }

    class AudioHistory {
        +id: Integer
        +user_id: Integer
        +text: Text
        +filename: String
        +voice_id: Integer
        +voice_name: String
        +speed: Integer
        +pitch: Integer
        +volume: Integer
        +created_at: DateTime
        +to_dict(): dict
    }

    User "1" --> "many" AudioHistory : 拥有
```

#### 2.3.4 数据库 ER 图（实体–联系）

```mermaid
erDiagram
    USER {
        int id PK
        string username
        string email
        string password_hash
        datetime created_at
    }

    AUDIO_HISTORY {
        int id PK
        int user_id FK
        text text
        string filename
        int voice_id
        string voice_name
        int speed
        int pitch
        int volume
        datetime created_at
    }

    USER ||--o{ AUDIO_HISTORY : owns
```

---

## 3 系统设计实现—系统实现

本章重点介绍弦外系统的具体实现过程，包括开发环境配置、核心后端实现、前端界面与交互实现、TTS 封装与调用、以及文件与安全管理等方面。

### 3.1 开发环境与技术选型

- **开发语言**：Python 3.x、JavaScript（ES6）。  
- **后端框架**：Flask（轻量级 Web 框架，便于快速开发和部署）。  
- **ORM 与数据库**：Flask‑SQLAlchemy + SQLite。  
- **前端技术栈**：原生 HTML5 + CSS3 + JavaScript，配合自定义样式与交互脚本（`main.css` / `auth.css`、`main.js` / `auth.js`）。  
- **第三方服务**：百度 AI 平台提供的语音合成 SDK（`aip` 包）。  
- **运行与依赖管理**：通过 `requirements.txt` 管理依赖包，使用本地虚拟环境或全局环境运行 Flask 应用。

在系统启动时，Flask 应用会自动创建数据库表结构，并确保音频上传目录 `uploads` 存在，为后续音频文件生成和访问提供基础设施。

### 3.2 后端实现

#### 3.2.1 Flask 应用配置

后端入口文件为 `app.py`，核心配置包括：

- 设置 `SECRET_KEY` 用于 Session 加密，防止会话被伪造。  
- 配置 `SQLALCHEMY_DATABASE_URI = 'sqlite:///xianwai.db'`，指定使用本地 SQLite 数据库。  
- 关闭 `SQLALCHEMY_TRACK_MODIFICATIONS` 以减少开销和警告。  
- 配置 `UPLOAD_FOLDER = 'uploads'`，设置最大上传内容大小 `MAX_CONTENT_LENGTH = 16 * 1024 * 1024`。  
- 使用 `os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)` 确保音频文件目录存在。  
- 从环境变量中读取百度 TTS 的 `APP_ID`、`API_KEY` 和 `SECRET_KEY`，用于初始化 `BaiduTTS` 客户端。

通过 `with app.app_context(): db.create_all()` 在应用启动时创建数据库表，保证系统首次运行即可使用。

#### 3.2.2 数据模型实现

系统通过 SQLAlchemy 定义 `User` 和 `AudioHistory` 两个模型类：

- `User` 模型包含用户名、邮箱、密码哈希和创建时间字段，并通过 `audio_history = db.relationship('AudioHistory', ...)` 与历史记录建立关系。  
- `AudioHistory` 模型中实现了 `to_dict` 方法，将对象转换为 JSON 可序列化的字典结构，方便 REST 接口直接返回给前端使用。

此设计简化了数据访问代码，提高了可维护性，同时为后续扩展（如增加更多用户属性或音频元数据）提供了空间。

#### 3.2.3 用户注册与登录实现

**（1）注册功能实现 `/register`**

- GET 请求返回注册页面模板 `register.html`。  
- POST 请求接收前端以 JSON 格式提交的注册数据，包括 `username`、`email`、`password`、`confirm_password`。  
- 后端对输入进行多重校验：  
  - 非空校验（所有字段不能为空）；  
  - 用户名长度限制（3–20 个字符）；  
  - 密码长度限制（至少 6 个字符）；  
  - 两次密码一致性校验；  
  - 用户名和邮箱唯一性检查。  
- 通过 `generate_password_hash` 对密码进行加密存储，防止明文密码泄露。  
- 注册成功后，自动将用户信息写入 Session，保持登录状态，并返回 JSON 结果给前端。

**（2）登录功能实现 `/login`**

- GET 请求：若已登录（Session 中存在 `user_id`），则重定向至 `/home`，否则渲染登录页面 `login.html`。  
- POST 请求：接收前端发送的 JSON，包括 `username`（可为用户名或邮箱）和 `password`。  
- 后端根据用户名或邮箱查询用户，并使用 `check_password_hash` 校验密码。  
- 登录成功后，在 Session 中保存 `user_id` 和 `username`，并返回 `success: True` 的 JSON 响应。  
- 登录失败时返回相应错误消息与 HTTP 状态码（401 或 400/500），支持前端做出友好提示。

**（3）会话与登出实现 `/logout`**

- 登出接口通过 `session.clear()` 清空当前会话，保证用户安全退出。  
- 操作完成后重定向至登录页，前端导航栏也提供“退出登录”按钮，调用该接口实现一键退出。

#### 3.2.4 文本转语音接口实现

核心接口 `/api/generate-audio` 负责将前端提交的文本转换为音频文件，并保存生成记录：

1. **登录校验**：若 Session 中不存在 `user_id`，则返回未登录错误（HTTP 401）。  
2. **TTS 客户端校验**：若百度 TTS 未正确配置，则返回服务未配置的错误提示。  
3. **参数解析与校验**：  
   - 从 JSON 请求体中读取 `text`、`voice`、`speed`、`pitch`、`volume` 等参数；  
   - 去除文本首尾空格并进行非空校验；  
   - 使用 `len(text.encode('gbk'))` 计算字节长度，保证不超过百度 TTS 的 1024 字节上限。  
4. **文件名与路径生成**：  
   - 使用 `uuid.uuid4().hex` 生成全局唯一文件名，避免冲突；  
   - 通过 `os.path.join(UPLOAD_FOLDER, filename)` 生成完整文件路径。  
5. **TTS 参数封装与调用**：  
   - 调用 `tts_client.get_supported_voices()` 获取发音人名称；  
   - 构建 `options = {'spd': speed, 'pit': pitch, 'vol': volume, 'per': voice}` 传递给 TTS；  
   - 调用 `tts_client.text_to_speech(text, output_file=filepath, options=options, cuid=f'user_{session["user_id"]}')` 生成音频。  
6. **结果处理与历史记录保存**：  
   - 若合成成功，则创建 `AudioHistory` 记录（包含文本、文件名、参数配置），并提交到数据库；  
   - 将 `audio_url`（指向 `/api/audio/<filename>` 的下载地址）返回给前端；  
   - 若失败，则返回错误信息和 500 状态码。

通过上述流程，系统实现了一个完整、可配置的文本转语音服务端接口。

#### 3.2.5 音频文件下载与历史记录接口实现

**（1）音频下载 `/api/audio/<filename>`**

- 先校验用户是否登录。  
- 再根据 `filename` 和当前用户 `user_id` 在 `AudioHistory` 中进行查询，确保用户仅能访问属于自己的音频文件。  
- 若校验通过，使用 `send_from_directory` 从 `uploads` 目录中返回对应文件，并启用 `as_attachment=True` 以下载形式提供。

**（2）历史记录接口 `/api/history`**

- GET：查询当前用户最近 50 条历史记录，按 `created_at` 倒序排序，通过 `to_dict` 序列化为列表返回。  
- POST：目前为兼容接口，前端生成时已自动保存，返回简单成功消息。  
- DELETE：清空当前用户所有历史记录，同时删除数据库记录，出现异常时回滚事务并返回错误信息。

**（3）单条历史删除 `/api/history/<int:history_id>`**

- 根据 `history_id` 和当前 `user_id` 查询记录，找不到则返回 404。  
- 找到后先删除对应音频文件，再删除数据库记录，并提交事务。  
- 若中途出错，通过 `db.session.rollback()` 回滚，保证数据库和文件系统的一致性。

#### 3.2.6 用户信息查询接口

接口 `/api/user/info` 用于在设置页中展示当前用户信息：

- 检查 Session 中是否存在 `user_id`，未登录返回 401。  
- 从数据库中查询用户对象，存在时返回 `id`、`username`、`email`、`created_at` 等信息。  
- 前端设置页通过该接口填充“账户信息”区域。

### 3.3 前端实现

前端部分主要由三个模板页面和对应的样式、脚本文件组成：

- `login.html`：登录页面。  
- `register.html`：注册页面。  
- `home.html`：主工作台页面（创作、历史记录、设置）。

#### 3.3.1 登录与注册页面

- 使用统一的 `auth.css` 实现整体视觉风格，包括背景波浪动画、卡片式登录框、按钮动效等。  
- 在 `auth.js` 中通过 JavaScript 绑定表单提交事件，使用 `fetch` 向后端 `/login` 与 `/register` 发送 JSON 请求：  
  - 在前端进行基础输入校验并显示错误提示；  
  - 请求过程中显示按钮加载动画；  
  - 根据后端返回结果弹出提示（成功/失败），成功后跳转到 `/home` 或 `/login`。  
- 密码输入框支持“显示/隐藏密码”切换，提升用户体验。

#### 3.3.2 创作页面与音频播放

`home.html` 是系统的核心工作页面，实现了三个主要 Tab：

- **创作 Tab**：  
  - 左侧为文本输入区域和语音参数设置：文本框实时统计字数，并在超过限制前提醒用户；  
  - 语速、音调、音量使用滑块控件展示，当前值通过旁边数字即时显示；  
  - “生成语音”按钮点击后调用 `/api/generate-audio`，并在生成期间显示加载遮罩层。  

- **音频预览区域**：  
  - 若尚未生成音频，显示“空状态”提示；  
  - 生成成功后，动态创建 `<audio>` 播放器，支持播放与暂停；  
  - 提供“下载”按钮触发 `/api/audio/<filename>` 接口下载音频。  

- **历史记录 Tab**：  
  - 通过 `/api/history` 接口加载当前用户的历史记录列表；  
  - 每条记录展示生成时间、部分文本内容、参数摘要等信息，并提供播放、下载和删除操作按钮；  
  - “清空历史”按钮调用 `DELETE /api/history` 一次性删除所有历史记录。

- **设置 Tab**：  
  - 通过 `/api/user/info` 获取并展示当前用户的用户名和邮箱；  
  - 支持设置默认发音人等偏好（可在后续版本扩展持久化保存）；  
  - 提供“退出登录”按钮调用 `/logout`。

前端脚本 `main.js` 负责：

- 绑定 Tab 切换逻辑；  
- 监听文本输入框实时更新字数统计；  
- 封装统一的消息提示组件（Toast）；  
- 对所有网络请求统一处理加载状态和错误提示。

### 3.4 TTS 封装与调用实现

文件 `AI_Text_to_Audio.py` 中实现了对百度 TTS 的二次封装 `BaiduTTS` 类：

- 在构造函数中初始化 `AipSpeech` 客户端，并保存默认语音参数（音量、语速、音调、发音人）。  
- 在 `text_to_speech` 方法中：  
  - 首先检查文本字节长度是否超过 1024，若超限直接返回错误；  
  - 合并默认参数与自定义参数，添加 `cuid` 标识；  
  - 调用 `client.synthesis` 接口进行语音合成，并判断返回结果类型：  
    - 若为字典，则表示出现错误，提取 `err_msg` 和 `err_no` 返回；  
    - 若为二进制数据，则写入指定 MP3 文件路径。  
- 提供 `get_supported_voices` 方法，统一维护系统支持的发音人列表，便于前端展示。  
- 提供带重试机制的 `text_to_speech_with_retry` 方法，在出现服务器繁忙或访问频率受限等可重试错误时自动多次尝试。

通过将百度 TTS 相关逻辑集中封装，后端业务代码只需关注“传入文本与参数、获取文件路径和错误信息”，提高了代码的清晰度和可维护性。

### 3.5 文件与安全管理

在系统实现过程中，还针对安全性做了以下考虑：

- **会话安全**：通过 `SECRET_KEY` 保护 Session，避免会话被伪造；所有需要登录的接口在进入逻辑前统一判断 Session。  
- **访问控制**：音频下载和历史记录相关接口均校验 `user_id`，防止跨用户访问他人音频文件或记录。  
- **输入校验**：对登录、注册、文本转语音输入进行严格校验，避免异常输入导致系统崩溃或逻辑错误。  
- **错误处理与事务管理**：对数据库写操作使用 `try/except` 包裹，出现异常时调用 `db.session.rollback()` 回滚事务，并返回清晰的错误信息给前端。

---

## 4 系统测试

### 4.1 测试环境

- **硬件环境**：普通 PC / 笔记本电脑。  
- **操作系统**：Windows 10。  
- **运行环境**：Python 3.x，已安装 `Flask`、`Flask‑SQLAlchemy`、`aip` 等依赖包。  
- **浏览器环境**：Chrome / Edge 等现代浏览器。

### 4.2 测试类型与方法

系统主要进行了以下几类测试：

- **单元测试（逻辑级）**  
  - 对 `BaiduTTS` 类的文本长度校验、错误返回等进行验证。  
  - 对用户注册输入校验逻辑进行模拟测试，确保边界条件处理正确。

- **接口测试（API 级）**  
  - 使用 Postman 或浏览器开发者工具，对 `/login`、`/register`、`/api/generate-audio`、`/api/history`、`/api/audio/<filename>` 等接口进行请求与响应验证。  
  - 检查 HTTP 状态码、返回 JSON 字段是否符合预期。

- **功能测试（端到端）**  
  - 从“注册新用户 → 登录 → 文本输入 → 生成语音 → 播放与下载 → 查看与删除历史记录 → 退出登录”的完整流程进行走查。  
  - 测试不同参数组合对生成语音的影响（发音人、语速、音调、音量）。

- **异常与边界测试**  
  - 输入空文本或超长文本，检查系统是否能给出明确错误提示；  
  - 使用错误密码登录、使用已注册邮箱再次注册等情况；  
  - 删除不存在或不属于当前用户的历史记录，确认接口能安全拒绝操作。

### 4.3 典型测试用例

以下列出若干典型测试用例（节选）：

- **用例 1：正常注册**  
  - 前置条件：用户名和邮箱未被使用。  
  - 输入：合法用户名、邮箱、两次一致的密码。  
  - 期望结果：返回 `success: True`，页面提示“注册成功”，自动登录并跳转至主页。

- **用例 2：重复邮箱注册**  
  - 前置条件：邮箱已注册。  
  - 输入：新的用户名、已存在的邮箱。  
  - 期望结果：返回 `success: False`，错误消息“邮箱已被注册”，不创建新用户。

- **用例 3：文本转语音（正常）**  
  - 前置条件：已登录，百度 TTS 配置正确。  
  - 输入：长度小于 1024 字节的中文文本，发音人 0，语速 5，音调 5，音量 5。  
  - 期望结果：返回 `success: True`，生成 MP3 文件，可在前端页面正常播放和下载，同时历史记录中新增一条记录。

- **用例 4：文本过长**  
  - 输入：长度超过 1024 字节的中文文本。  
  - 期望结果：返回 `success: False`，错误信息“文本长度超过1024字节限制”，不生成音频文件。

- **用例 5：历史记录删除**  
  - 操作：在历史记录页面删除一条指定记录。  
  - 期望结果：前端列表中该记录消失，对应音频文件从 `uploads` 目录删除，刷新页面后记录不再出现。

### 4.4 测试结果分析

通过上述测试，系统在以下方面表现良好：

- 用户注册、登录、登出流程稳定，错误提示明确；  
- 文本转语音功能在百度 TTS 正常可用的前提下，能稳定生成音频文件，参数生效正常；  
- 历史记录的新增、查询、删除、清空操作逻辑正确，数据与文件状态保持一致；  
- 前端界面交互流畅，错误情况能通过弹窗或提示条友好展示给用户。

仍可改进的方向包括：

- 增加更完善的自动化测试脚本，覆盖更多异常场景；  
- 对网络异常和第三方服务限流情况增加更细致的降级策略和提示信息。

---

## 5 总结

弦外（Xian Wai）系统通过 Flask + SQLite + 百度 TTS 的技术组合，实现了一个集“文本转语音、音频管理、用户管理”于一体的智能播客创作平台。系统采用清晰的分层架构和模块化设计，前后端职责划分明确，具备良好的可维护性和可扩展性。

在实现过程中，重点解决了文本长度限制、音频文件管理、用户权限控制以及与第三方 TTS 服务的集成等问题。通过系统性测试，验证了主要功能模块的正确性与稳定性，为后续在更大规模数据、更多发音人和更复杂业务场景下的扩展打下了良好基础。


